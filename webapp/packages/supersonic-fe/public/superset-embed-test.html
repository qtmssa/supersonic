<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Superset Embed SDK 测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 16px;
      }
      #container {
        width: 1000px;
        height: 720px;
        max-width: 100%;
        max-height: calc(100vh - 260px);
        border: 1px solid #e5e5e5;
      }
      .row {
        margin-bottom: 12px;
      }
      label {
        display: inline-block;
        width: 140px;
      }
      input {
        width: 520px;
        padding: 6px 8px;
      }
      select {
        width: 520px;
        padding: 6px 8px;
      }
      button {
        padding: 6px 12px;
      }
      .hint {
        color: #666;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h2>Superset Embed SDK 测试页</h2>
    <div class="row hint">
      使用步骤：加载 dashboard 列表并选择 → 确认 Embedded ID → 点击“获取 guestToken” → 确认响应 → 点击“开始嵌入”
    </div>
    <div class="row">
      <label>Superset 域名</label>
      <input id="supersetDomain" value="http://10.0.12.244:8088" />
    </div>
    <div class="row">
      <label>Supersonic API Base</label>
      <input id="supersonicApiBase" placeholder="http://127.0.0.1:9090" />
    </div>
    <div class="row">
      <label>Dashboards 接口</label>
      <input id="dashboardsApi" value="/api/chat/superset/dashboards" />
    </div>
    <div class="row">
      <label>Dashboard</label>
      <select id="dashboardSelect"></select>
      <button id="refreshDashboardsBtn">加载列表</button>
    </div>
    <div class="row hint" id="dashboardHint"></div>
    <div class="row">
      <label>Embedded ID</label>
      <input id="embeddedId" placeholder="选择 dashboard 后自动填充" />
    </div>
    <div class="row hint" id="embeddedIdHint"></div>
    <div class="row">
      <label>Auth Token</label>
      <input id="authToken" placeholder="SUPERSONIC_TOKEN" readonly />
    </div>
    <div class="row hint" id="authTokenHint"></div>
    <div class="row">
      <label>Guest Token 接口</label>
      <input id="guestTokenApi" value="/api/chat/superset/guest-token" />
    </div>
    <div class="row">
      <button id="fetchTokenBtn">获取 guestToken</button>
      <button id="embedBtn">开始嵌入</button>
      <span class="hint">首次加载会请求 guest token</span>
    </div>
    <div class="row">
      <div id="tokenResult" class="hint"></div>
    </div>
    <div id="container"></div>

    <script src="./superset-embedded-sdk/index.js"></script>
    <script>
      const { embedDashboard } = window.supersetEmbeddedSdk || {};
      const container = document.getElementById('container');
      const embedBtn = document.getElementById('embedBtn');
      const fetchTokenBtn = document.getElementById('fetchTokenBtn');
      const refreshDashboardsBtn = document.getElementById('refreshDashboardsBtn');
      const dashboardSelect = document.getElementById('dashboardSelect');
      const dashboardsApiInput = document.getElementById('dashboardsApi');
      const supersonicApiBaseInput = document.getElementById('supersonicApiBase');
      const embeddedIdInput = document.getElementById('embeddedId');
      const embeddedIdHint = document.getElementById('embeddedIdHint');
      const dashboardHint = document.getElementById('dashboardHint');
      const authTokenInput = document.getElementById('authToken');
      const authTokenHint = document.getElementById('authTokenHint');

      const AUTH_TOKEN_KEY = 'SUPERSONIC_TOKEN';

      const syncAuthToken = () => {
        const token = localStorage.getItem(AUTH_TOKEN_KEY) || '';
        authTokenInput.value = token;
        authTokenHint.textContent = token ? '' : '未检测到 SUPERSONIC_TOKEN，auth token 不能为空';
        return token;
      };

      const normalizeBearer = token => (token.startsWith('Bearer ') ? token : `Bearer ${token}`);

      const normalizeBaseUrl = value => {
        const trimmed = (value || '').trim();
        if (!trimmed) {
          return '';
        }
        return trimmed.endsWith('/') ? trimmed.slice(0, -1) : trimmed;
      };

      const resolveSupersonicBaseUrl = () => {
        const inputValue = normalizeBaseUrl(supersonicApiBaseInput.value);
        if (inputValue) {
          return inputValue;
        }
        if (window.location.origin && !window.location.origin.startsWith('file://')) {
          return window.location.origin;
        }
        return '';
      };

      const buildApiUrl = (baseUrl, apiPath) => {
        const trimmed = (apiPath || '').trim();
        if (!trimmed) {
          return '';
        }
        if (/^https?:\/\//i.test(trimmed)) {
          return trimmed;
        }
        if (!baseUrl) {
          return trimmed;
        }
        if (trimmed.startsWith('/')) {
          return `${baseUrl}${trimmed}`;
        }
        return `${baseUrl}/${trimmed}`;
      };

      const buildAuthHeaders = authToken => {
        const headers = { 'Content-Type': 'application/json' };
        if (authToken) {
          const bearer = normalizeBearer(authToken);
          headers.Authorization = bearer;
          headers.auth = bearer;
        }
        return headers;
      };

      const parseResultList = data => {
        if (Array.isArray(data)) {
          return data;
        }
        if (Array.isArray(data?.data)) {
          return data.data;
        }
        if (Array.isArray(data?.result)) {
          return data.result;
        }
        if (Array.isArray(data?.data?.result)) {
          return data.data.result;
        }
        return [];
      };

      const updateDashboardHint = message => {
        dashboardHint.textContent = message || '';
      };

      const fetchGuestToken = async (apiUrl, embeddedId, authToken) => {
        const headers = buildAuthHeaders(authToken);
        const resp = await fetch(apiUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify({ embeddedId }),
        });
        const data = await resp.json();
        const tokenResult = document.getElementById('tokenResult');
        tokenResult.textContent = `guest-token response: ${JSON.stringify(data)}`;
        const token = data?.data?.token || '';
        if (token) {
          alert(`guestToken: ${token}`);
        } else {
          alert('guestToken 为空，请检查接口响应');
        }
        return token;
      };

      const fetchDashboards = async ({ silent = false } = {}) => {
        const baseUrl = resolveSupersonicBaseUrl();
        const apiUrl = buildApiUrl(baseUrl, dashboardsApiInput.value);
        const authToken = syncAuthToken();
        updateDashboardHint('');
        if (!apiUrl) {
          if (!silent) {
            alert('请填写 Dashboards 接口或 Supersonic API Base');
          }
          return [];
        }
        if (!authToken) {
          if (!silent) {
            alert('auth token 不能为空');
          }
          return [];
        }
        if (!baseUrl && !/^https?:\/\//i.test(dashboardsApiInput.value.trim())) {
          if (!silent) {
            alert('当前为 file:// 环境，请填写 Supersonic API Base');
          }
          return [];
        }
        const resp = await fetch(apiUrl, {
          method: 'POST',
          headers: buildAuthHeaders(authToken),
          body: JSON.stringify({}),
        });
        const text = await resp.text();
        let data = null;
        try {
          data = text ? JSON.parse(text) : null;
        } catch (err) {
          updateDashboardHint('Dashboard 列表响应不是 JSON，请检查接口。');
          return [];
        }
        const code = data?.code;
        if (code != null && Number(code) !== 200) {
          const message = data?.msg || data?.message || 'Dashboard 接口返回失败';
          updateDashboardHint(`加载失败: ${message}`);
          return [];
        }
        if (!resp.ok) {
          updateDashboardHint(`加载失败: ${resp.status} ${resp.statusText}`);
          return [];
        }
        const list = parseResultList(data);
        if (list.length === 0 && !silent) {
          updateDashboardHint('未获取到 dashboard，请检查接口响应或权限。');
        }
        return list;
      };

      const renderDashboards = dashboards => {
        dashboardSelect.replaceChildren();
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = dashboards.length ? '请选择 dashboard' : '未获取到 dashboard';
        dashboardSelect.appendChild(placeholder);
        dashboards.forEach(item => {
          const option = document.createElement('option');
          const id = item?.id;
          const embeddedId = item?.embeddedId || item?.embedded_id || item?.embeddedUuid || '';
          const title = item?.title || item?.dashboardTitle || '未命名';
          option.value = embeddedId || '';
          option.dataset.dashboardId = id == null ? '' : String(id);
          option.dataset.embeddedId = embeddedId;
          option.textContent =
            id == null ? title : `${title} (id: ${id}${embeddedId ? ', embedded' : ''})`;
          dashboardSelect.appendChild(option);
        });
      };

      const syncEmbeddedId = () => {
        const selected = dashboardSelect.options[dashboardSelect.selectedIndex];
        if (!selected) {
          embeddedIdInput.value = '';
          embeddedIdHint.textContent = '';
          return;
        }
        const embeddedId = selected.dataset.embeddedId || '';
        embeddedIdInput.value = embeddedId;
        if (!embeddedId && selected.dataset.dashboardId) {
          embeddedIdHint.textContent =
            '当前接口未返回 embeddedId，如需自动填充请让后端补充该字段。';
        } else {
          embeddedIdHint.textContent = '';
        }
      };

      const doEmbed = async () => {
        const authToken = syncAuthToken();
        const supersetDomain = document.getElementById('supersetDomain').value.trim();
        const embeddedId = embeddedIdInput.value.trim();
        const guestTokenApiRaw = document.getElementById('guestTokenApi').value.trim();
        const baseUrl = resolveSupersonicBaseUrl();
        const guestTokenApi = buildApiUrl(baseUrl, guestTokenApiRaw);

        if (!authToken) {
          alert('auth token 不能为空');
          return;
        }
        if (!supersetDomain || !embeddedId || !guestTokenApi) {
          alert('请填写 Superset 域名、Embedded ID 和 Guest Token 接口');
          return;
        }
        if (!baseUrl && !/^https?:\/\//i.test(guestTokenApiRaw)) {
          alert('当前为 file:// 环境，请填写 Supersonic API Base');
          return;
        }

        if (!embedDashboard) {
          alert('Superset Embed SDK 未加载，请检查 /superset-embedded-sdk/index.js');
          return;
        }
        container.replaceChildren();
        await embedDashboard({
          id: embeddedId,
          supersetDomain,
          mountPoint: container,
          fetchGuestToken: () => fetchGuestToken(guestTokenApi, embeddedId, authToken),
          dashboardUiConfig: {
            hideTitle: true,
            hideTab: true,
            hideChartControls: false,
            filters: { visible: false, expanded: false },
          },
        });
      };

      fetchTokenBtn.addEventListener('click', () => {
        const authToken = syncAuthToken();
        const embeddedId = embeddedIdInput.value.trim();
        const guestTokenApiRaw = document.getElementById('guestTokenApi').value.trim();
        const baseUrl = resolveSupersonicBaseUrl();
        const guestTokenApi = buildApiUrl(baseUrl, guestTokenApiRaw);
        if (!authToken) {
          alert('auth token 不能为空');
          return;
        }
        if (!embeddedId || !guestTokenApi) {
          alert('请填写 Embedded ID 和 Guest Token 接口');
          return;
        }
        if (!baseUrl && !/^https?:\/\//i.test(guestTokenApiRaw)) {
          alert('当前为 file:// 环境，请填写 Supersonic API Base');
          return;
        }
        fetchGuestToken(guestTokenApi, embeddedId, authToken).catch(err => {
          console.error(err);
          alert('获取 guestToken 失败，请查看控制台错误');
        });
      });

      embedBtn.addEventListener('click', () => {
        doEmbed().catch(err => {
          console.error(err);
          alert('嵌入失败，请查看控制台错误');
        });
      });

      refreshDashboardsBtn.addEventListener('click', () => {
        fetchDashboards()
          .then(dashboards => {
            renderDashboards(dashboards);
            syncEmbeddedId();
          })
          .catch(err => {
            console.error(err);
            alert('加载 dashboard 失败，请查看控制台错误');
          });
      });

      dashboardSelect.addEventListener('change', () => {
        syncEmbeddedId();
      });

      syncAuthToken();
      fetchDashboards({ silent: true })
        .then(dashboards => {
          renderDashboards(dashboards);
          syncEmbeddedId();
        })
        .catch(err => {
          console.error(err);
        });
    </script>
  </body>
</html>
